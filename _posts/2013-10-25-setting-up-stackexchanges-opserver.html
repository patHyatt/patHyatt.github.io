---
layout: post
title: Setting up StackExchange's Opserver
date: '2013-10-25T19:36:00.002-04:00'
author: Pat Hyatt
tags:
- Nick Craver
- StackOverflow
- StackExchange
- .NET
- Opserver
- C#
- exception
- monitoring
modified_time: '2013-10-25T19:38:16.860-04:00'
thumbnail: http://2.bp.blogspot.com/-vb_mZnUqkbg/Umr5EG_0qxI/AAAAAAAAAlU/NqRWLyaC9nk/s72-c/blog_redis.png
blogger_id: tag:blogger.com,1999:blog-1130780247100205939.post-6230668647083139269
blogger_orig_url: http://patpack.blogspot.com/2013/10/setting-up-stackexchanges-opserver.html
---

<span style="font-family: Arial, Helvetica, sans-serif;"><a href="http://nickcraver.com/blog/">Nick Craver</a> from <a href="http://stackexchange.com/">StackExchange</a> recently posted StackExchange's homegrown monitoring system.  The system, named <a href="https://github.com/opserver/Opserver">Opserver </a>is available on <a href="http://github.com/">GitHub</a>.</span><br /><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span><span style="font-family: Arial, Helvetica, sans-serif;">In this post I hope to gloss over some of the issues and/or configuration steps necessary to run this slick monitor.</span><br /><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span><span style="font-family: Arial, Helvetica, sans-serif;">So lets try this.</span><br /><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;"><br /></span></h3><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;">&nbsp;Installation:&nbsp;</span></h3><ol><li><span style="font-family: Arial, Helvetica, sans-serif;">Grab the code from GitHub either, for the lazy here is the <a href="https://github.com/opserver/Opserver/archive/master.zip">zip file link</a>.&nbsp;</span></li><li><span style="font-family: Arial, Helvetica, sans-serif;">If using Visual Studio 2010 or previous, make sure you have ASP.NET MVC installed. Grab that <a href="http://www.asp.net/mvc/mvc4">here</a> and make sure to run the installer as administrator [Windows 7+].&nbsp;</span></li><li><span style="font-family: Arial, Helvetica, sans-serif;">Crack open the solution file (either from your cloned repo OR the unzipped package downloaded in step ). There should be 2 projects visible and loaded. If you get a "The project file '.....csproj' cannot be opened. The project type is not supported by this installation." error, see this <a href="http://stackoverflow.com/questions/1531120/asp-net-mvc-project-not-supported-by-this-installation#1532183">StackOverflow answer</a>.</span></li><li><span style="font-family: Arial, Helvetica, sans-serif;">Compile. You should have no errors and everything succeeds.&nbsp;</span></li></ol><div><span style="font-family: Arial, Helvetica, sans-serif;"><i>Side note</i>: This codebase was built using Visual Studio 2012 and recently updated to use Visual Studio 2013.</span></div><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;"><br /></span></h3><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;">Configuration:</span></h3><div><span style="font-family: Arial, Helvetica, sans-serif;">All configuration is handled by .json files in the Opserver/Config directory. Nick has a .example file for each of the different types of dashboards there are. Some of these appear to be very centric to StackExchanges build, so out of the box you may not be able to use all the configurations without reworking some areas of your codebase.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;"><br /></span></h3><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;">SecuritySettings.json</span></h3><div><span style="font-family: Arial, Helvetica, sans-serif;">This is the first file you'll need to copy/paste in order to get into the system.&nbsp;</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Edit this file to match the security settings you want.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">The example looks like this:</span></div><div><pre style="background-color: #333333; background-position: initial initial; background-repeat: initial initial; color: #dfdfbf;"><blockquote class="tr_bq"><br /><span style="font-family: Arial, Helvetica, sans-serif; font-size: x-small;">&lt;?<span style="color: #efc986;">xml</span>&nbsp;version="<span style="color: #dfaf8f;">1.0</span>"&nbsp;encoding="<span style="color: #dfaf8f;">utf-8</span>"?&gt;<br />&lt;<span style="color: #efc986;">SecuritySettings</span>&nbsp;provider="<span style="color: #dfaf8f;">AD</span>"&gt;<br /> &lt;!--<span style="color: #7a987a;">&nbsp;Optional,&nbsp;these&nbsp;networks&nbsp;can&nbsp;see&nbsp;the&nbsp;overview&nbsp;dashboard&nbsp;without&nbsp;authentication&nbsp;</span>--&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span style="color: #efc986;">InternalNetworks</span>&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;<span style="color: #efc986;">Network</span>&nbsp;name="<span style="color: #dfaf8f;">SE&nbsp;Internal</span>"&nbsp;cidr="<span style="color: #dfaf8f;">10.0.0.0/8</span>"&nbsp;/&gt;<br />&nbsp;&nbsp;&nbsp;&nbsp;&lt;/<span style="color: #efc986;">InternalNetworks</span>&gt;<br />&lt;/<span style="color: #efc986;">SecuritySettings</span>&gt;<br /> <br />&lt;!--<span style="color: #7a987a;">&nbsp;</span><span style="color: #7a987a;">Example&nbsp;of&nbsp;global&nbsp;access&nbsp;for&nbsp;everyone:</span><span style="color: #7a987a;">&lt;SecuritySettings&nbsp;provider="alladmin"&nbsp;/&gt;</span>--&gt;</span></blockquote><br /></pre></div><div><span style="font-family: Arial, Helvetica, sans-serif;">which limits access to StackExchange's internal network, yours will need to be changed</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Possible "provider" attributes are: "activedirectory", "ad", "alladmin", or no attribute in which everyone is read only. "ad" and "activedirectory" are analogous.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">For my case I have everyone being an admin, since this is mainly for our internal development and QA teams.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Mine looks like this:</span><br /><pre style="background-color: #333333; background-position: initial initial; background-repeat: initial initial; color: #dfdfbf;"><span style="font-family: Arial, Helvetica, sans-serif; font-size: x-small;">&lt;?<span style="color: #efc986;">xml</span>&nbsp;version="<span style="color: #dfaf8f;">1.0</span>"&nbsp;encoding="<span style="color: #dfaf8f;">utf-8</span>"?&gt;<br />&lt;<span style="color: #efc986;">SecuritySettings</span>&nbsp;provider="<span style="color: #dfaf8f;">alladmin</span>"&gt;<br />&lt;/<span style="color: #efc986;">SecuritySettings</span>&gt; </span></pre><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span><span style="font-family: Arial, Helvetica, sans-serif;">Note, even if everyone is an admin, they will have to login initially using an empty username/password combination to get into the system.</span><br /><h3><span style="font-family: Arial, Helvetica, sans-serif;"><span style="font-size: small;"><br /></span></span></h3><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;">RedisSettings.json</span></h3></div><div><span style="font-family: Arial, Helvetica, sans-serif;">If you do not know what Redis is or do not use it skip this.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Adding a RedisSettings.json file allows you to monitor Redis memory use as well as perform some health checks.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">The configuration for Redis is a tad cryptic for me still, so bear with me.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Here is our config file, modified to remove server names and specifics:</span></div><div><pre style="background-color: #333333; background-position: initial initial; background-repeat: initial initial; color: #dfdfbf;"><span style="font-family: Arial, Helvetica, sans-serif; font-size: x-small;">{<br /> "allServers":&nbsp;{<br />  "name":&nbsp;"All",<br />  "instances":&nbsp;[<br />   {<br />    "name":&nbsp;"Core",    <br />    "analysisRegexes":&nbsp;{<br />     "**Dev**":&nbsp;"^dev-",<br />     "**Live**":&nbsp;"^prod-",<br />    }<br />   }   <br />  ]<br /> },<br /> "Servers":&nbsp;[<br />  {&nbsp;"name":&nbsp;"server1"&nbsp;},<br />  {&nbsp;"name":&nbsp;"server1Slave1"&nbsp;},<br />  {&nbsp;"name":&nbsp;"server2"&nbsp;},<br />  {&nbsp;"name":&nbsp;"server2Slave1"&nbsp;},<br />  {&nbsp;"name":&nbsp;"server2Slave2"&nbsp;}<br /> ]<br />}</span></pre></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Under the instances array we have a "Core" name and two children that define regular expressions to match Redis key names for categorizing. That is, if a key starts with "dev-", it will be categorized as "**Dev**" under the "Core" instance when running analysis.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">The Servers array defines the server names your Redis instances are running on.&nbsp;</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Here's a screenshot of what the Redis monitor home page looks like:</span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-vb_mZnUqkbg/Umr5EG_0qxI/AAAAAAAAAlU/NqRWLyaC9nk/s1600/blog_redis.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><span style="font-family: Arial, Helvetica, sans-serif;"><img border="0" height="92" src="http://2.bp.blogspot.com/-vb_mZnUqkbg/Umr5EG_0qxI/AAAAAAAAAlU/NqRWLyaC9nk/s400/blog_redis.png" width="400" /></span></a></div><div><span style="font-family: Arial, Helvetica, sans-serif;">You can see the "Core" name in use on the left.</span></div><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;"><br /></span></h3><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;">SQLSettings.json</span></h3><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;"><span style="font-weight: normal;">The entries in this file define the connection strings for any SQL server instances you wish to monitor. There are two main arrays to populate, "clusteres" and "instances".</span></span></h3><div><span style="font-family: Arial, Helvetica, sans-serif;">"clusters" refers to SQL Server 2012 cluster configurations. If the SQL instance you put in here are not SQL Server 2012 you can get memory use spark charts only. Outside of that it will appear offline.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">"instances" refers to standalone SQL server instances, and at least in our internal setup, make up a majority of our SQLSettings configuration.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Our configuration, truncated some for brevity:</span></div><div><pre style="background-color: #333333; background-position: initial initial; background-repeat: initial initial; color: #dfdfbf; font-family: Consolas;"><span style="font-size: x-small;">{<br />&nbsp;&nbsp;&nbsp;&nbsp;"defaultConnectionString":&nbsp;"Data&nbsp;Source=$ServerName$;Initial&nbsp;Catalog=master;Integrated&nbsp;Security=SSPI;",<br />&nbsp;&nbsp;&nbsp;&nbsp;"clusters":&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "name":&nbsp;"SDCluster01",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "nodes":&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  {&nbsp;"name":&nbsp;"SDCluster01\\SDCluster01_01"&nbsp;},<br />   {&nbsp;"name":&nbsp;"SDCluster02\\SDCluster01_02"&nbsp;},<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;"instances":&nbsp;[&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;"name":&nbsp;"SDDB01"&nbsp;},<br /> {&nbsp;"name":&nbsp;"SDDB02"&nbsp;},<br /> {&nbsp;"name":&nbsp;"SDDB03"&nbsp;},<br /> {&nbsp;"name":&nbsp;"SDDB04"&nbsp;},<br />&nbsp;&nbsp;&nbsp;&nbsp;]<br />}</span></pre></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Any one of the JSON objects that have a "name" property, can also specify a "connectionString" entry in case it differs from the "defaultConnectionString"'s entry.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Here is a display of our non 2012 cluster and information:</span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-mCUf9nkdEyU/Umr9z6sg7GI/AAAAAAAAAlg/sK3xXOjIQ9c/s1600/blog_sql.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="207" src="http://1.bp.blogspot.com/-mCUf9nkdEyU/Umr9z6sg7GI/AAAAAAAAAlg/sK3xXOjIQ9c/s400/blog_sql.png" width="400" /></a></div><div><span style="font-family: Arial, Helvetica, sans-serif;">As you can see, the top "cluster" is highlighted in red, even tho the spark chart is coming in.&nbsp;</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Also you can see under the standalone grouping we have 1 instance that's not up at all.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">Each one of these instances you can drill into to obtain more detailed information, for example:</span></div><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-HDk9FmYdorM/Umr-cHnXn9I/AAAAAAAAAlo/XDLQbBdh7DI/s1600/blog_sql2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="288" src="http://4.bp.blogspot.com/-HDk9FmYdorM/Umr-cHnXn9I/AAAAAAAAAlo/XDLQbBdh7DI/s400/blog_sql2.png" width="400" /></a></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;"><br /></span></h3><h3><span style="font-family: Arial, Helvetica, sans-serif; font-size: small;">ExceptionsSettings.json</span></h3><div><span style="font-family: Arial, Helvetica, sans-serif;">To use this monitor panel, you pretty much need to use&nbsp;<a href="https://github.com/NickCraver/StackExchange.Exceptional">StackExchange.Exceptional</a>. This, again, is StackExchange's error logging system, which writes unhandled exceptions to a central database.&nbsp;</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">If you happen to not use this, skip this for now.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">The configuration for this is pretty straight forward for a quick setup, the only necessary item is the connection string of the database your Exceptional logging system is writing to.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><pre style="background-color: #333333; background-position: initial initial; background-repeat: initial initial; color: #dfdfbf;"><span style="font-family: Arial, Helvetica, sans-serif; font-size: x-small;">{<br />&nbsp;&nbsp;&nbsp;&nbsp;"warningRecentCount":&nbsp;"100",<br />&nbsp;&nbsp;&nbsp;&nbsp;"criticalRecentCount":&nbsp;"200",<br />&nbsp;&nbsp;&nbsp;&nbsp;"viewGroups":&nbsp;"StatusExceptionsRO",<br />&nbsp;&nbsp;&nbsp;&nbsp;"applications":&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Core",  <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Customer Support",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"API",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Intranet",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Polling"<br />&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;"stores":&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"name":&nbsp;"SanDiego",<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"queryTimeoutMs":&nbsp;2000,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"pollIntervalSeconds":&nbsp;10,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"connectionString":&nbsp;"Server=SDDB_01;Database=Exceptions;Integrated&nbsp;Security=SSPI;"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;]<br />}</span></pre></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">String items underneath "applications" defines what is displayed by default on the Exception pages header. If an exception is written to the database that does not fit any of those application names, a new category will display in the pane.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">I was going to post a screenshot, but after blurring out anything from our stack, it was useless. I would like to add however, that both Exceptional and the Exception page are just beautiful.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><br /></div><div><br /></div><h3><span style="font-family: Arial, Helvetica, sans-serif;">Conclusion</span></h3><div><span style="font-family: Arial, Helvetica, sans-serif;">So far my coworkers and I love this, and I can see from the code its only getting better (hello there sp_WhoIsActive, sp_BlitzIndex!).</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;">I hope this helps someone. Together with Exceptional I've personally found 3 issues with our codebase not previously known, scary but also eye opening. And I think that is the goal, make your errors eye opening and easy to see, so you can fix them.</span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div><div><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span></div>